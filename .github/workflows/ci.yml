name: OZMetaDB CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: 1. Validate
    runs-on: ubuntu-latest
    steps:
      - name: 1.1 Checkout code
        uses: actions/checkout@v4

      - name: 1.2 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 1.3 Install Python deps
        run: pip install jsonschema

      - name: 1.4 Validate schema syntax
        run: python3 -c "import json; json.load(open('exports/spec/ozmeta.metadata.snapshot.schema.json'))"

      - name: 1.5 Validate sample against schema
        run: |
          python3 -c "
          import json
          from jsonschema import validate
          schema = json.load(open('exports/spec/ozmeta.metadata.snapshot.schema.json'))
          sample = json.load(open('exports/samples/sample.snapshot.json'))
          validate(sample, schema)
          print('Schema validation: PASSED')
          "

  generate:
    name: 2. Generate
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: 2.1 Checkout code
        uses: actions/checkout@v4

      - name: 2.2 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 2.3 Run generator
        run: |
          python3 generator/src/generate_from_snapshot.py \
            --snapshot tests/fixtures/sample.snapshot.json \
            --out out/ci-run

      - name: 2.4 List generated files
        run: ls -la out/ci-run/sql/

  golden-test:
    name: 3. Golden Test
    runs-on: ubuntu-latest
    needs: generate
    steps:
      - name: 3.1 Checkout code
        uses: actions/checkout@v4

      - name: 3.2 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3.3 Run golden tests
        run: |
          python3 scripts/run_golden_tests.py \
            --fixture tests/fixtures/sample.snapshot.json \
            --golden tests/golden/sample \
            --out out/golden-run

  python-syntax:
    name: 4. Python Syntax
    runs-on: ubuntu-latest
    steps:
      - name: 4.1 Checkout code
        uses: actions/checkout@v4

      - name: 4.2 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 4.3 Check Python syntax
        run: |
          python3 -m py_compile generator/src/generate_from_snapshot.py
          python3 -m py_compile generator/src/export_from_db.py
          python3 -m py_compile scripts/run_golden_tests.py
          echo "Python syntax: OK"
